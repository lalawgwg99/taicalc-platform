<!DOCTYPE html>
<html lang="zh-TW" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../favicon.svg" type="image/svg+xml">
    <title>2026 房貸試算 (新青安版)｜TaiCalc</title>
    <meta name="description" content="2026 新青安房貸試算。支援寬限期、分段利率計算，精準模擬補貼結束後的月付金變化。比較一般房貸與優惠貸款差異。">
    <link rel="canonical" href="https://taicalc.com/tools/mortgage">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        stone: {
                            50: '#fafaf9',
                            800: '#292524',
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
</head>

<body class="bg-stone-50 text-stone-800 min-h-screen flex flex-col font-sans">
    <div id="app" v-cloak class="flex-grow max-w-2xl mx-auto w-full px-4 sm:px-6 py-8">

        <!-- Header / Global Nav -->
        <nav class="flex items-center justify-between mb-8">
            <a href="../index.html" class="flex items-center gap-2 group">
                <span
                    class="text-xl font-bold tracking-tight text-stone-800 group-hover:text-amber-600 transition-colors">TaiCalc</span>
            </a>
            <div class="flex gap-4 sm:gap-6 text-sm font-medium text-stone-500">
                <a href="../dashboard.html"
                    class="text-emerald-600 font-bold hover:text-emerald-700 transition-colors">生活儀表板</a>
                <a href="../index.html" class="hover:text-stone-900 transition-colors">首頁</a>
                <a href="../categories/tools.html" class="hover:text-stone-900 transition-colors">工具</a>
            </div>
        </nav>

        <header class="mb-8">
            <div class="flex items-center justify-between mb-2">
                <h1 class="text-2xl sm:text-3xl font-bold text-stone-800 tracking-tight">房貸試算 (新青安版)</h1>
                <span
                    class="text-xs px-2.5 py-1 rounded-full bg-green-100 text-green-700 border border-green-200 font-medium">2026年版</span>
            </div>
            <p class="text-stone-500 text-sm">支援寬限期與分段利率。精準計算 2026 新青安補貼截止後還款變化。</p>
        </header>

        <main class="space-y-6">

            <div class="card bg-white rounded-2xl shadow-sm border border-stone-200 overflow-hidden">
                <!-- Presets -->
                <div class="grid grid-cols-2 border-b border-stone-200">
                    <button @click="applyPreset('newYouth')"
                        class="py-3 text-sm font-bold text-center transition-colors hover:bg-green-50 text-green-700 border-r border-stone-100">
                        🏠 新青安 2026 (40年)
                    </button>
                    <button @click="applyPreset('general')"
                        class="py-3 text-sm font-bold text-center transition-colors hover:bg-stone-50 text-stone-600">
                        🏦 一般房貸 (30年)
                    </button>
                </div>

                <div class="p-6 space-y-6">

                    <!-- Basic Inputs -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2">
                            <label class="block text-xs font-semibold text-stone-500 mb-1">貸款總額 (萬)</label>
                            <input type="number" v-model.number="amountWan" aria-label="貸款總額" placeholder="1000"
                                title="貸款總額"
                                class="w-full bg-stone-50 border border-stone-200 rounded-xl py-3 px-4 text-stone-800 text-xl font-bold focus:outline-none focus:ring-2 focus:ring-green-500/20 focus:border-green-500 transition-all">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-stone-500 mb-1">期限 (年)</label>
                            <input type="number" v-model.number="years" aria-label="期限"
                                class="w-full bg-stone-50 border border-stone-200 rounded-xl py-3 px-4 text-stone-800 font-bold focus:outline-none focus:ring-2 focus:ring-green-500/20 focus:border-green-500">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-stone-500 mb-1">寬限期 (年)</label>
                            <select v-model.number="graceYears" aria-label="寬限期"
                                class="w-full bg-stone-50 border border-stone-200 rounded-xl py-3 px-4 text-stone-800 font-bold focus:outline-none focus:ring-2 focus:ring-green-500/20 focus:border-green-500">
                                <option :value="0">無寬限期</option>
                                <option v-for="y in 5" :key="y" :value="y">{{ y }} 年</option>
                            </select>
                        </div>
                    </div>

                    <!-- Rate Settings -->
                    <div class="bg-stone-50 rounded-xl p-4 border border-stone-200 space-y-3">
                        <div class="flex items-center justify-between">
                            <h3 class="text-sm font-bold text-stone-700">利率設定 (分段式)</h3>
                            <button @click="twoStageMode = !twoStageMode" class="text-xs text-blue-600 hover:underline">
                                {{ twoStageMode ? '切換單一利率' : '啟用分談利率 (補貼退場)' }}
                            </button>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-semibold text-stone-500 mb-1">
                                    {{ twoStageMode ? '第一段利率 (%)' : '年利率 (%)' }}
                                </label>
                                <input type="number" v-model.number="rate1" step="0.005" aria-label="第一段利率或年利率"
                                    class="w-full bg-white border border-stone-200 rounded-lg py-2 px-3 text-stone-800 font-bold focus:outline-none focus:ring-1 focus:ring-green-500">
                            </div>

                            <div v-if="twoStageMode">
                                <label class="block text-xs font-semibold text-stone-500 mb-1">第二段利率 (%)</label>
                                <input type="number" v-model.number="rate2" step="0.005" aria-label="第二段利率"
                                    class="w-full bg-white border border-stone-200 rounded-lg py-2 px-3 text-stone-800 font-bold focus:outline-none focus:ring-1 focus:ring-green-500">
                            </div>
                        </div>

                        <div v-if="twoStageMode">
                            <label class="block text-xs font-semibold text-stone-500 mb-1">第一段期間 (月)</label>
                            <div class="flex gap-2 items-center">
                                <input type="number" v-model.number="stage1Months" title="第一段期間 (月)" placeholder="7"
                                    class="w-20 bg-white border border-stone-200 rounded-lg py-2 px-3 text-stone-800 font-bold focus:outline-none focus:ring-1 focus:ring-green-500">
                                <span class="text-xs text-stone-400">個月後變更 (如: 2026/8 退場剩 7 個月)</span>
                            </div>
                        </div>
                    </div>

                    <!-- Prepayment Settings -->
                    <div class="bg-stone-50 rounded-xl p-4 border border-stone-200 space-y-3">
                        <div class="flex items-center justify-between">
                            <h3 class="text-sm font-bold text-stone-700">提前還款 (Prepayment)</h3>
                            <button @click="prepaymentMode = !prepaymentMode"
                                class="text-xs text-blue-600 hover:underline">
                                {{ prepaymentMode ? '關閉試算' : '開啟試算' }}
                            </button>
                        </div>

                        <div v-if="prepaymentMode" class="grid grid-cols-2 gap-4 animate-fade-in-up">
                            <div>
                                <label class="block text-xs font-semibold text-stone-500 mb-1">每月多還 (元)</label>
                                <input type="number" v-model.number="extraMonthly" placeholder="0"
                                    class="w-full bg-white border border-stone-200 rounded-lg py-2 px-3 text-stone-800 font-bold focus:outline-none focus:ring-1 focus:ring-green-500">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-stone-500 mb-1">單筆大額還款 (萬)</label>
                                <div class="flex gap-2">
                                    <input type="number" v-model.number="extraLump" placeholder="0"
                                        class="w-full bg-white border border-stone-200 rounded-lg py-2 px-3 text-stone-800 font-bold focus:outline-none focus:ring-1 focus:ring-green-500">
                                </div>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-xs font-semibold text-stone-500 mb-1">大額還款時間 (第幾年)</label>
                                <div class="flex gap-2 items-center">
                                    <input type="range" v-model.number="lumpYear" min="1" :max="years-1"
                                        class="flex-grow h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-green-600">
                                    <span class="text-sm font-bold text-stone-700 w-16 text-right">第 {{lumpYear}}
                                        年</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Results -->
                    <div class="pt-4 border-t border-stone-100 grid gap-4">

                        <!-- Monthly Pay -->
                        <div
                            class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-6 border border-green-100 text-center">
                            <p class="text-xs text-green-700 uppercase tracking-wide mb-1">預估月付金</p>

                            <!-- Logic for Displaying Ranges -->
                            <div v-if="graceYears > 0">
                                <p class="text-sm font-medium text-green-600 mb-1">寬限期內 ({{graceYears}}年)</p>
                                <p class="text-3xl font-bold font-mono text-green-800 mb-3">${{ fmt(results.gracePay) }}
                                </p>

                                <div class="h-px bg-green-200 w-1/2 mx-auto my-3"></div>

                                <p class="text-sm font-medium text-green-600 mb-1">寬限期後</p>
                                <p class="text-2xl font-bold font-mono text-green-800">${{ fmt(results.afterGracePay) }}
                                </p>
                                <p v-if="twoStageMode && results.stage2Pay !== results.afterGracePay"
                                    class="text-xs text-green-600/70 mt-1">
                                    (利率變更後: ${{ fmt(results.stage2Pay) }})
                                </p>
                            </div>
                            <div v-else>
                                <p class="text-3xl font-bold font-mono text-green-800">${{ fmt(results.basePay) }}</p>
                                <p v-if="twoStageMode && results.stage2Pay !== results.basePay"
                                    class="text-sm text-green-600 mt-2">
                                    第 {{stage1Months + 1}} 個月起: ${{ fmt(results.stage2Pay) }}
                                </p>
                            </div>
                        </div>

                        <!-- Summary Stats -->
                        <div class="grid grid-cols-2 gap-4 text-xs">
                            <div class="bg-stone-50 p-3 rounded-xl border border-stone-200">
                                <span class="block text-stone-400 mb-1">利息總支出</span>
                                <span class="block text-lg font-bold text-stone-700 font-mono">${{
                                    fmt(results.totalInterest) }}</span>
                            </div>
                            <div class="bg-stone-50 p-3 rounded-xl border border-stone-200">
                                <span class="block text-stone-400 mb-1">本息總額</span>
                                <span class="block text-lg font-bold text-stone-700 font-mono">${{
                                    fmt(results.totalPayment) }}</span>
                            </div>
                        </div>

                        <!-- Prepayment Comparison -->
                        <div v-if="prepaymentMode && (extraMonthly > 0 || extraLump > 0)"
                            class="mt-4 bg-amber-50 rounded-xl p-4 border border-amber-100 animate-fade-in-up">
                            <h4 class="text-amber-800 font-bold mb-2 flex items-center gap-2">
                                <span>🎉 提前還款效益</span>
                            </h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <span class="block text-amber-600/80 text-xs mb-1">節省利息</span>
                                    <span class="block text-xl font-bold text-amber-700 font-mono">${{
                                        fmt(results.interestSaved) }}</span>
                                </div>
                                <div>
                                    <span class="block text-amber-600/80 text-xs mb-1">縮短時間</span>
                                    <span class="block text-xl font-bold text-amber-700 font-mono">{{
                                        Math.floor(results.monthsSaved / 12) }}年 {{ results.monthsSaved % 12 }}月</span>
                                </div>
                                <div
                                    class="col-span-2 pt-2 border-t border-amber-200/50 flex justify-between items-center">
                                    <span class="text-amber-600/80 text-xs">預計還清時間</span>
                                    <span class="text-sm font-bold text-amber-800 font-mono">第 {{
                                        Math.floor(results.finalMonths / 12) + 1 }} 年</span>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Notes -->
            <div class="text-xs text-stone-400 space-y-1 opacity-80 px-2">
                <p>註：計算採用本息平均攤還法。</p>
                <p>新青安試算預設：前7個月 (至2026/7) 有補貼，之後回復一般利率。</p>
                <p v-if="prepaymentMode">提前還款計算：假設每月增加還款金額優先沖銷本金，且維持原設定的每月應繳本息金額 (縮短年限法)。</p>
            </div>
        </main>

        <footer class="text-center mt-12 text-stone-400 text-sm pb-8">
            <p class="mb-2">© 2026 TaiCalc</p>
            <a href="mailto:service@taicalc.com"
                class="text-xs text-stone-300 hover:text-stone-500 transition-colors">回報問題 (Report Issue)</a>
        </footer>
    </div>

    <script>
        const { createApp, ref, computed, watch, onMounted } = Vue

        createApp({
            setup() {
                const amountWan = ref(1000) // 1000萬
                const years = ref(40)
                const graceYears = ref(5)

                const rate1 = ref(1.775)
                const rate2 = ref(2.15)
                const twoStageMode = ref(true)
                const stage1Months = ref(7)

                // Prepayment State
                const prepaymentMode = ref(false)
                const extraMonthly = ref(0)
                const extraLump = ref(0)
                const lumpYear = ref(3) // Default 3rd year

                const applyPreset = (type) => {
                    if (type === 'newYouth') {
                        amountWan.value = 1000
                        years.value = 40
                        graceYears.value = 5
                        rate1.value = 1.775
                        rate2.value = 2.15
                        twoStageMode.value = true
                        stage1Months.value = 7
                    } else if (type === 'general') {
                        amountWan.value = 1200
                        years.value = 30
                        graceYears.value = 0
                        rate1.value = 2.185
                        twoStageMode.value = false
                    }
                }

                const fmt = (n) => n ? Math.round(n).toLocaleString('zh-TW') : '0'

                const PMT = (rateYear, nMonths, pv) => {
                    if (rateYear === 0) return pv / nMonths
                    const r = rateYear / 100 / 12
                    return pv * r * Math.pow(1 + r, nMonths) / (Math.pow(1 + r, nMonths) - 1)
                }

                const results = computed(() => {
                    const loan = (amountWan.value || 0) * 10000
                    const totalMonths = (years.value || 0) * 12
                    const graceMonths = (graceYears.value || 0) * 12
                    const changeMonth = twoStageMode.value ? stage1Months.value : 99999

                    if (totalMonths <= 0) return {}

                    // Rate Helper
                    const getRate = (m) => ((m <= changeMonth) ? rate1.value : (rate2.value || rate1.value)) / 100 / 12

                    // Pass 1: Original Schedule
                    let bal1 = loan
                    let totInt1 = 0
                    let pmts = []
                    let payGrace = 0
                    let payStart = 0
                    let payStage2 = 0
                    let currentStdPMT = 0

                    for (let m = 1; m <= totalMonths; m++) {
                        const r = getRate(m)
                        const int = bal1 * r
                        totInt1 += int

                        let pmt = 0
                        if (m <= graceMonths) {
                            pmt = int
                            if (m === 1) payGrace = pmt
                        } else {
                            if (m === graceMonths + 1 || m === changeMonth + 1) {
                                const rem = totalMonths - m + 1
                                currentStdPMT = PMT(getRate(m) * 12 * 100, rem, bal1)
                            }
                            pmt = currentStdPMT
                            if (m === graceMonths + 1) payStart = pmt
                            if (m === changeMonth + 1) payStage2 = pmt
                        }

                        pmts.push(pmt)
                        const prin = pmt - int
                        bal1 -= prin
                    }

                    // Pass 2: Prepayment
                    let totInt2 = totInt1
                    let realMonths = totalMonths

                    if (prepaymentMode.value && (extraMonthly.value > 0 || extraLump.value > 0)) {
                        let bal2 = loan
                        totInt2 = 0
                        realMonths = 0
                        const lumpM = (lumpYear.value * 12)

                        let balPrepay = loan

                        for (let m = 1; m <= totalMonths; m++) {
                            if (balPrepay <= 10) {
                                if (realMonths === 0) realMonths = m - 1
                                break
                            }
                            realMonths = m // actively paying

                            const r = getRate(m)
                            const int = balPrepay * r
                            totInt2 += int

                            let basePmt = pmts[m - 1] || 0
                            let actualPay = 0

                            if (m <= graceMonths) {
                                actualPay = int
                            } else {
                                actualPay = basePmt
                            }

                            let extra = (extraMonthly.value || 0)
                            if (m === lumpM) extra += (extraLump.value || 0) * 10000

                            let totalPay = actualPay + extra

                            if (totalPay > balPrepay + int) totalPay = balPrepay + int

                            const prin = totalPay - int
                            balPrepay -= prin
                        }
                    }

                    return {
                        gracePay: payGrace,
                        afterGracePay: payStart,
                        stage2Pay: payStage2 || payStart,
                        basePay: payStart,
                        totalInterest: totInt1,
                        totalPayment: loan + totInt1,

                        // New Results
                        newTotalInterest: totInt2,
                        newTotalPayment: loan + totInt2,
                        monthsSaved: totalMonths - realMonths,
                        interestSaved: totInt1 - totInt2,
                        finalMonths: realMonths
                    }
                })

                // Auto-save for Dashboard
                watch(results, (newVal) => {
                    // Use standard monthly payment (basePay or afterGracePay)
                    // If user is in grace period, maybe we should store the 'after grace' pay for conservative estimate?
                    // Or let's store the MAX of current pay vs future pay to be safe?
                    // Let's store the current actual payment for now (basePay).
                    // Actually, for "Monthly Expense" planning, usually we want the current burden.
                    // But if it's grace period, it might be misleadingly low.
                    // Let's stick to 'basePay' (which is the payment *after* grace period in my logic above? wait.)

                    // Logic review:
                    // if m <= graceMonths: pmt = int (gracePay)
                    // else: pmt = standard (afterGracePay)

                    // Let's save the current payment based on logic: if graceYears > 0, save gracePay (current reality).
                    // But also maybe save the future pay? The dashboard is "Current Finance".
                    // Let's save the calculated 'totalPayment / totalMonths' ? No, cashflow is monthly.

                    // Decision: Save the HIGHER of gracePay or afterGracePay to be conservative for "Financial Health".
                    // OR just save the one that represents "Monthly Mortgage".
                    // Let's save "afterGracePay" (Full P+I) as it reflects true liability.
                    if (newVal.afterGracePay > 0) {
                        localStorage.setItem('taicalc_mortgage_monthly', Math.floor(newVal.afterGracePay))
                    } else {
                        localStorage.removeItem('taicalc_mortgage_monthly')
                    }
                }, { deep: true, immediate: true })

                // Persistence
                onMounted(() => {
                    const saved = localStorage.getItem('taicalc_mortgage_inputs')
                    if (saved) {
                        try {
                            const data = JSON.parse(saved)
                            if (data.amountWan) amountWan.value = data.amountWan
                            if (data.years) years.value = data.years
                            if (data.graceYears !== undefined) graceYears.value = data.graceYears
                            if (data.rate1) rate1.value = data.rate1
                            if (data.rate2) rate2.value = data.rate2
                            if (data.twoStageMode !== undefined) twoStageMode.value = data.twoStageMode
                        } catch (e) { }
                    }
                })

                watch([amountWan, years, graceYears, rate1, rate2, twoStageMode], (vals) => {
                    localStorage.setItem('taicalc_mortgage_inputs', JSON.stringify({
                        amountWan: vals[0], years: vals[1], graceYears: vals[2],
                        rate1: vals[3], rate2: vals[4], twoStageMode: vals[5]
                    }))
                })

                return {
                    amountWan, years, graceYears,
                    rate1, rate2, twoStageMode, stage1Months,
                    prepaymentMode, extraMonthly, extraLump, lumpYear,
                    results, applyPreset, fmt
                }
            }
        }).mount('#app')
    </script>
</body>

</html>